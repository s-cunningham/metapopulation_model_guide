<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>RAMAS Workflow Instructions – Metapopulation Workflow</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Metapopulation Workflow</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overall-workflow" id="toc-overall-workflow" class="nav-link active" data-scroll-target="#overall-workflow">Overall workflow:</a></li>
  <li><a href="#edit-ramas-config-module" id="toc-edit-ramas-config-module" class="nav-link" data-scroll-target="#edit-ramas-config-module">1. Edit RAMAS Config Module</a></li>
  <li><a href="#prepping-raster-files" id="toc-prepping-raster-files" class="nav-link" data-scroll-target="#prepping-raster-files">2. Prepping Raster Files</a></li>
  <li><a href="#determine-suitability-thresholds" id="toc-determine-suitability-thresholds" class="nav-link" data-scroll-target="#determine-suitability-thresholds">3. Determine suitability thresholds</a></li>
  <li><a href="#set-template-demographic-parameters-in-ramas-metapopulation" id="toc-set-template-demographic-parameters-in-ramas-metapopulation" class="nav-link" data-scroll-target="#set-template-demographic-parameters-in-ramas-metapopulation">4. Set template demographic parameters in RAMAS Metapopulation</a></li>
  <li><a href="#importing-spatial-data-and-linking-to-demographic-information" id="toc-importing-spatial-data-and-linking-to-demographic-information" class="nav-link" data-scroll-target="#importing-spatial-data-and-linking-to-demographic-information">5. Importing spatial data and linking to demographic information</a></li>
  <li><a href="#calculate-patches" id="toc-calculate-patches" class="nav-link" data-scroll-target="#calculate-patches">6. Calculate Patches</a></li>
  <li><a href="#export-results-and-metapop-file-from-spatial-data-module" id="toc-export-results-and-metapop-file-from-spatial-data-module" class="nav-link" data-scroll-target="#export-results-and-metapop-file-from-spatial-data-module">7. Export Results and Metapop file from Spatial Data module</a></li>
  <li><a href="#running-the-actual-metapopulation-model" id="toc-running-the-actual-metapopulation-model" class="nav-link" data-scroll-target="#running-the-actual-metapopulation-model">8. Running the actual Metapopulation model</a></li>
  <li><a href="#conducting-a-sensitivity-analysis" id="toc-conducting-a-sensitivity-analysis" class="nav-link" data-scroll-target="#conducting-a-sensitivity-analysis">9. Conducting a Sensitivity Analysis</a></li>
  <li><a href="#comparing-simulation-results" id="toc-comparing-simulation-results" class="nav-link" data-scroll-target="#comparing-simulation-results">10. Comparing simulation results</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">RAMAS Workflow Instructions</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>RAMAS is immensely powerful, but seems to require some finesse in setting up the models, and is somewhat unclear as to what parameters need to be set…and when and how. In this tutorial, we walk readers through an example to provide a basis of understanding on how to set up and run analyses in this program. This will also serve as a record for purposes of reproducibility.</p>
<p><em>Note for readers: This is not an exhaustive tutorial, and there are many settings we skip over because they are not applicable to our study.</em></p>
<section id="overall-workflow" class="level3">
<h3 class="anchored" data-anchor-id="overall-workflow">Overall workflow:</h3>
<ol type="i">
<li>Set RAMAS configurations to increase the size of allowed input raster.</li>
<li>Prepare spatial information and create habitat layer, determine suitability thresholds.</li>
<li>Build template Metapop file (template.mp) with demographic information.</li>
<li>Import habitat layer into Spatial Data and link Spatial Data file to template.mp</li>
<li>Identify habitat patches</li>
<li>Export new Metapop file that includes populations based on habitat patches</li>
<li>Make final edits to pop model, run simulation</li>
<li>Perform sensitivity analysis and compare results</li>
<li>Plotting patches and converting ASCII patch file to .tif (R &amp; ArcGIS Pro)</li>
</ol>
</section>
<section id="edit-ramas-config-module" class="level2">
<h2 class="anchored" data-anchor-id="edit-ramas-config-module">1. Edit RAMAS Config Module</h2>
<ol type="1">
<li><p>To be able to import the entirety of a large raster, you have to change the number of raster cells in the configuration module. In the Maxima tab, the default number of rows and columns (400 rows, 500 columns) is too few, in our case for Mississippi at a 1 km<sup>2</sup> resolution. Therefore, we changed the map rows and map columns values (in red box in figure below) to slightly higher than the dimensions of our raster (545 rows, 317 columns). RAMAS has a limit of 16,000 cells in both columns and rows. Click save.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-01-06 132701-01.png" class="img-fluid figure-img"></p>
<figcaption>Maxima tab of CONFIG subprogram</figcaption>
</figure>
</div></li>
<li><p>Now we need we save the correct file path so that the changes we made apply when we build the models. Go to the ‘Other’ tab. At the right of the box that says Data File Path, click on the button with three dots and navigate to the folder where you will be saving your RAMAS Models. Click Save and exit the Configuration module. *Note: Check the manual if this is not working.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-01-06 132952.png" class="img-fluid figure-img"></p>
<figcaption>‘Other’ tab of CONFIG subprogram</figcaption>
</figure>
</div></li>
</ol>
</section>
<section id="prepping-raster-files" class="level2">
<h2 class="anchored" data-anchor-id="prepping-raster-files">2. Prepping Raster Files</h2>
<p>RAMAS provides the option of imported a pre-made habitat suitability layer (hereafter referred to as ‘habitat layer’), or importing individual spatial layers and calculating suitability manually. Here, we built the habitat layer in R and predicted across the study area, and will therefore only need the final predicted layer to import. We will use the <code>terra</code> package in program <code>R</code> to format the habitat layer and export it as an ASCII (pronounced ‘ask · ee’; .asc file extension) file so that it can be read in by RAMAS, though you can also prepare spatial information like this in ArcGIS Pro (ESRI) or other GIS programs. Some code for manipulating a raster to resample, crop, apply a linear stretch is below, but the full code used is available on figshare (DOI: 10.6084/m9.figshare.28628264).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load shapefile with state outline</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>state_outline <span class="ot">&lt;-</span> <span class="fu">vect</span>(<span class="st">"data/mississippi_outline.shp"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Load raster with predicted resource selection function</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"data/predicted_resource_selection.tif"</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Make template raster (what you want the final resolution to be - here, we use 90 m)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that sometimes resampling and reprojecting rasters results in cells having slightly different length/width</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># for example, 90.0000647, 90.0000935...even with these incredibly small differences, RAMAS will not run!! </span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>temp_rast <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="fu">ext</span>(state_outline), <span class="at">resolution=</span><span class="dv">90</span>) </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Resample to resolution of template raster</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">resample</span>(pred, temp_rast)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Mask and crop the predicted output so that there are as few extra lines of no data or data outside the study area as possible using vector information</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">mask</span>(pred, state_outline)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">crop</span>(pred, <span class="fu">ext</span>(state_outline))</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Rescale raster to be between 0 and 1</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> (pred<span class="sc">-</span><span class="fu">minmax</span>(pred)[<span class="dv">1</span>])<span class="sc">/</span>(<span class="fu">minmax</span>(pred)[<span class="dv">2</span>]<span class="sc">-</span><span class="fu">minmax</span>(pred)[<span class="dv">1</span>])</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill missing data with 0</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">0</span>))</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">classify</span>(pred, m)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Write .tif</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(pred, <span class="st">"data/predictions/rsf_FINAL.tif"</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Write ASCII file</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(pred, <span class="st">"data/predictions/rsf_FINAL.asc"</span>, <span class="at">NAflag=</span><span class="sc">-</span><span class="dv">9999</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: include the argument overwrite=TRUE in writeRaster() to rewrite over the old file if you need to rerun something.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="determine-suitability-thresholds" class="level2">
<h2 class="anchored" data-anchor-id="determine-suitability-thresholds">3. Determine suitability thresholds</h2>
<p>Now that we’ve created a habitat layer, we need to determine the threshold that we will consider “core” habitat. We recommend doing this in the same R session as creation of the habitat layer. Hold on to this value, we will need in RAMAS Spatial Data. A potential value can be estimated by examining quantiles of RSF values at used locations. See code on figshare for details (DOI: 10.6084/m9.figshare.28628264).</p>
</section>
<section id="set-template-demographic-parameters-in-ramas-metapopulation" class="level2">
<h2 class="anchored" data-anchor-id="set-template-demographic-parameters-in-ramas-metapopulation">4. Set template demographic parameters in RAMAS Metapopulation</h2>
<ol type="1">
<li>We need to create a “template” population file that will be used by the Spatial Data module. RAMAS Spatial Data will take the demographic information from this template and use it to populate individual patches with starting demographic information when we export a metapopulation file from Spatial Data, and incorporate the spatial configuration when we run the metapopulation model. It is recommended to fill out Stages, Sex structure, Stage matrix, Standard deviation matrix, Stochasticity, and Catastrophes sections for import into Spatial Data. Open then RAMAS Metapopulation subprogram.</li>
<li>In the top of the program window, click on Model. This will open a list of the sections that we need to edit. We will fill these out starting at the top of the list and moving down.</li>
<li>Start with General Information.
<ul>
<li>Add a <strong>title</strong> (e.g., ‘Pigs template’) and optionally any <strong>comments</strong>.</li>
<li>Leave Map features blank.</li>
<li>Change the <strong>number of replications</strong> - this is the number of times the population will be simulated, and if incorporating stochasticity there should be multiple replications, but if no stochasticity will be incorporated into the final model, leaves as 1. We set this to 5000.</li>
<li>Set the <strong>Duration</strong> (number of time steps) you wish the simulation to be projected. In our case, we projected the population over 10 years.</li>
<li>Enter a value to specify the interval of a <strong>time step</strong>. You can select from the drop-down to change time steps to have values of months, days, or years (default). In our case, we want a timestep equal to 1 year, so we enter 1 in the box. Hit ok to close the menu.</li>
</ul></li>
<li>Next, open the Stages menu. This is where we tell RAMAS about the population structure
<ul>
<li><p><strong>Name:</strong> List the ages or stages that will be included in your population model. It is helpful to indicate sex along with the stage/age name to keep everything organized. For example, we have three stages for both males and females. <em>Always start listing female stages first, then males stages.</em> In our pig model, we had three stages for each sex: piglets, yearlings, and adults, so in total we had 6 stages listed in the Stages menu. Click Add to add a stage.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-01-28 151527.png" class="img-fluid figure-img"></p>
<figcaption>Stages menu for wild pigs in MS. Three stages each for males and females</figcaption>
</figure>
</div></li>
<li><p><strong>Relative Dispersal:</strong> When there are multiple patches, RAMAS will calculate a dispersal rate between patches (based on function in Dispersal menu, which we won’t edit in the template population). <em>The Relative Dispersal column is relative to the overall dispersal specified in the Dispersal dialog</em>. At least one stage should have relative dispersal of 1. A value of 0 means that individuals in that stage do not disperse. Note that this is <strong>NOT</strong> the same as natal dispersal within a patch, though those values may be used to set relative values (e.g., between males and female dispersers). For example, because 54% of male pigs disperse while only 35% of female pigs disperse, we set male piglet relative dispersal to 1, and female pig dispersal to 0.35/0.54 = 0.65. We included a small percentage for dispersing yearling males. Note that this value only comes into play when there are &gt;1 patches identified by RAMAS Spatial Data.</p></li>
<li><p><strong>Average Weight:</strong> Used when calculating harvest ratios. Leave as 1 unless explicitly modeling harvest.</p></li>
<li><p><strong>Exclude:</strong> Switching to ‘Yes’ will exclude that particular stage from the population total. Otherwise, all stages are summed when calculating abundance.</p></li>
<li><p><strong>Basis for DD:</strong> Carrying capacity will be calculated based on stages marked as ‘Yes’, and thus could be used to model competition for territories.</p></li>
<li><p><strong>Breeding:</strong> The breeding column is to indicate the <em>proportion of each class that is physically/physiologically capable of breeding</em>, <em>not</em> <em>the proportion of individuals that typically breed in a given year</em> (which should be incorporated into fecundity values). This value ranges 0-1, and any stage with a fecundity should have a value &gt;0 in the Breeding column. Because pigs can reach sexual maturity by 5 or 6 months, we entered a value of 0.5 for piglets.</p></li>
<li><p>Click OK to close the Stages menu.</p></li>
</ul></li>
<li>Open the Sex Structure menu
<ul>
<li><p>The Sex Structure menu tells RAMAS how you are modeling populations. The default is a females-only model.</p></li>
<li><p>Determine from the list which best represents your population. In our study, we selected <strong>Both males and females, in separate stages</strong>.</p></li>
<li><p>Because we selected the option with both males and females, we need to specify the number of female stages. As noted in the program, we usually have the same number of male and female stages (but often vital rates may vary between sexes). Here, we had 3 stages for females (pigs, yearlings, and adults) because we had 6 total stages.</p></li>
<li><p>We also need to specify the mating system because we have both males and females in our model. We selected polygynous for pigs, and we assume that males can have unlimited partners (i.e., they can mate with any receptive female they come across). Click OK to save and close the Sex Structure menu.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-01-14 102304-01.png" class="img-fluid figure-img"></p>
<figcaption>Sex structure menu with options selected for wild pigs</figcaption>
</figure>
</div></li>
</ul></li>
<li>Open the Stage Matrix menu
<ul>
<li><p>The stage matrix is where you enter the survival and fecundity values for each age or stage. Multiple matrices can be added, for example, if different population dynamics are expected in different areas/under different conditions.</p></li>
<li><p>In general, fecundities are placed in the top row. In a female-only matrix, these values represent the number of female offspring produced per female. In a 2-sex matrix, we additionally include the male offspring produced per female of each age/stage, but on a separate line. Survival rates from one age/stage to the next follow the sub-diagonal, while the diagonal represents the probability of surviving in a stage but not moving on to the next (not relevant for age matrices). Thus, in the matrix below, there are three stages that only last 1 year, while individuals in the 4th stage can stay in that stage for multiple years.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-01-08 073737.png" class="img-fluid figure-img" width="615"></p>
<figcaption>Visualization of demographic data in a 2-sex matrix model with 4 stages</figcaption>
</figure>
</div></li>
<li><p>In a 2-sex matrix, the top right quadrant will be gray because these should all be 0s (with the exception of species that change sex by stage). Additional matrices can be added by clicking the Add button. Each matrix can be given a unique name. The Fecundity and Survival coeff parameters can be left as 1, these are used only when creating a new matrix, in which you want to change the vital rates by a constant coefficient. In that case, you would add a value in the coeff box, then click Auto Fill.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-01-16 075100.png" class="img-fluid figure-img"></p>
<figcaption>Stage matrix menu for a model including both males and females</figcaption>
</figure>
</div></li>
<li><p>We need to add constraints for RAMAS to account for vital rates properly. Click on Constraints and then Auto Fill and click OK to save and exit.</p></li>
<li><p>Click OK to save and exit the Stage Matrix menu</p></li>
</ul></li>
<li>Open the Standard Deviation Matrix menu
<ul>
<li><p>The standard deviation matrix provides values for each parameter to incorporate demographic stochasticity. This matrix should have stand deviations in the same matrix cells where survival and fecundity were added in the stage matrix, unless it is desired to model stochasticity in only some parameters.</p></li>
<li><p>Instead of manually filling the standard deviations, RAMAS can auto-fill the Standard deviation matrix using coefficient of variation. Click on Auto Fill in the bottom left corner. We can allow for 10% variability in vital rates by filling in 0.1 in both text boxes.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-01-14 095709.png" class="img-fluid figure-img"></p>
<figcaption>Auto Fill dialog box of Standard Deviation Matrix menu</figcaption>
</figure>
</div></li>
<li><p>Click OK to close Auto Fill, then OK again to save and close the Standard Deviation Matrix menu.</p></li>
</ul></li>
<li>Stochasticity menu: We did not add this to our model because stochasticity was already incorporated as uncertainty in vital rates and we have a relatively stable population of pigs across the state. In other words, we are not trying to model extinction or explosion, so we were OK with accepting the defaults here. However, if you want to incorporate these sorts of dynamics this would be the place to do so.</li>
<li>Catastrophes menu: The catastrophes menu is for incorporating rare, devastating effects (e.g., hurricane or wildfire). There is the option to specify two catastrophes and control how they affect the population. For our study, our species is not subject to major catastrophic events, so we did not incorporate catastrophes.</li>
<li>Save the metapopulation file (e.g., pigs_template.mp) by clicking on File &gt; Save. Note that the main screen has been populated with the values you entered (including replications, number of stages, density dependence, etc.). Close the Metapopulation subprogram.</li>
</ol>
</section>
<section id="importing-spatial-data-and-linking-to-demographic-information" class="level2">
<h2 class="anchored" data-anchor-id="importing-spatial-data-and-linking-to-demographic-information">5. Importing spatial data and linking to demographic information</h2>
<ol type="1">
<li><p>Open the RAMAS Spatial Data subprogram.</p></li>
<li><p>Again, at top of the program window, click on Model. This will open a list of the sections that we need to edit, similar to RAMAS Metapopulation.</p></li>
<li><p>Fill in General information.</p>
<ul>
<li>As in the Metapopulation subprogam, we want to give the session a <strong>title</strong> (does not need to be the same as what you will save the file)</li>
<li>Add <strong>comments</strong> if necessary or helpful.</li>
<li>Change the value in the <strong>cell length</strong> box to reflect the resolution of your rasters. Since we are using a 1 km<sup>2</sup> raster, we can leave the value as 1, but if we would have had a larger raster cell size (e.g., 2.25 km<sup>2)</sup>, we would need to adjust this value to 1.5.</li>
<li>Leave <strong>map features</strong> blank again.</li>
</ul></li>
<li><p>Go to Model &gt; Input maps to load habitat layers</p>
<ul>
<li>Click <strong>Add</strong>, which will population the ‘Maps:’ section with ‘Map 1’.</li>
<li>You can change the <strong>name</strong> of Map 1 to something more informative, such as PigMeanHSI</li>
<li>In the line that says <strong>File:</strong>, click on the button with three dots and navigate to the folder with your habitat layer. You may need change the filetype (in the bottom right )to All files (*<em>.*</em>) in order to see available .asc files. Select the habitat layer you want to import and click OK.</li>
<li><strong>Format</strong> will automatically population (it should read ARC/INFO if you’ve read in an ASCII file).</li>
<li>Click on the <strong>View</strong> button (bottom left corner of Input Maps menu). This will show you a preview of your habitat layer, and it will give you a warning if the entire raster is unable to load. In that case, you will need to go back and readjust the RAMAS configuration to increase the number of rows or columns.</li>
<li>After closing the View window, <strong># of columns</strong> will automatically populate.</li>
<li>Once the desired rasters are loaded, click OK and close the window.</li>
</ul></li>
<li><p>Next, go to Model &gt; Habitat relationships</p>
<ul>
<li><p>This section controls how RAMAS delineates the patches. It is possible to upload habitat layers and specify a <strong>suitability function</strong> within RAMAS; however, the modeling capabilities are limited. Thus, we imported the raster generated from resource selection modeling, but still need to specify a function for habitat suitability. In this case, it is just the imported layer * 1. Note that the name of the habitat layer must be in square brackets. Do not include and equal sign (=).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-02-26 095113.png" class="img-fluid figure-img"></p>
<figcaption>Settings for mapping pig core patches</figcaption>
</figure>
</div></li>
<li><p>The <strong>habitat suitability threshold for patches</strong> is the suitability value that RAMAS will use to convert the continuous habitat layer into a binary patch map, while everything below the threshold becomes “matrix”, or unsuitable habitat. This should be determined as part of the habitat suitability modeling process in R, or using other criteria.</p></li>
<li><p>The <strong>Neighborhood distance</strong> specifies the distance between discrete sections of suitable habitat that can considered a single patch. The RAMAS manual illustrates (p.&nbsp;15) the distances for values 1.2 to approximately 2.8, and recommends using these values. However, large values may be included, but it will likely impact computation time. Here, we used a distance that was approximately twice the average dispersal distance (e.g., average for pigs is 4-5 km, so we used a value of 10 km).</p></li>
<li><p><strong>Habitat suitability map color</strong> and <strong>Decimals for habitat suitability</strong> can be left as default; they control the visualization of the habitat map that is generated if one is calculated in the function box.</p></li>
<li><p>Click OK to save and close the habitat relationships menu.</p></li>
</ul></li>
<li><p>Go to Model &gt; Link to metapopulation. This menu is where we connect the template metapopulation to the habitat patches.</p>
<ul>
<li><p>There are two tabs: General and Catastrophes. Most of the information will be contained in the General tab.</p></li>
<li><p>The first option allows us to specify a function that will determine <strong>carrying capacity</strong> for each patch and the overall study map. RAMAS has four patch variables built in (p.&nbsp;16 in the RAMAS user guide): total patch suitability (<code>ths</code>), average patch suitability (<code>ahs</code>), number of cells in the patch (<code>noc</code>), and the length of the patch perimeter (<code>per</code>). Thus, these can be used to adjust the population parameters according to patch attributes. The RAMAS manual (p.&nbsp;28) describes functions that can be used to incorporate these variables (beyond simple mathematics). In our model, we wanted to set the greatest suitability to reflect a density of 8 wild pigs/km<sup>2</sup>, and reduce the density as suitability decreased. Thus, we multiply 8 wild pigs/km<sup>2</sup> by <code>ths</code>. Note: our habitat layer is a 1 km<sup>2</sup> grid, so we can use 8 wild pigs in the calculation. However, if we had a coarser grid, say 1.5 x 1.5 km (2.25 km<sup>2</sup>), we would need to account for this in density (e.g., 18 pigs per 2.25 km<sup>2</sup> grid cell).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-02-06 094916.png" class="img-fluid figure-img"></p>
<figcaption>Link to Metapopulation menu for wild pigs in Mississippi</figcaption>
</figure>
</div></li>
<li><p>The <strong>maximum growth</strong> rate (<em>R<sub>max</sub>)</em> is a tricky parameter. It represented the maximum finite rate of increase (often represented as 𝜆) for a population, when the population is not experiencing effects of density dependence. This value must be &gt;1 even if the population being modeled is expected to decrease. We looked for population modeling studies in the literature that estimated 𝜆 and used the highest as a starting point, but note that this has implications for the strength of density dependence when incorporated into a metapopulation model. The RAMAS user guide provides some context.</p></li>
<li><p>Next, we need to specify an <strong>initial abundance</strong> for each patch. Giving just an integer will assign this value to every patch, regardless of size or carrying capacity. RAMAS allows for functions to determine initial abundance, similar to carrying capacity, to adjust for overall patch suitability, size, etc. The default given in the manual is <code>noc</code> * 1.2 - <code>per</code> * 0.1, which incorporates the number of cells and the length of the patch perimeter in determining the initial abundance. We edited this function to be (<code>noc</code> * 8 * <code>ahs</code>) - <code>per</code> * 0.1, where 8 is the density of wild pigs/km<sup>2</sup>.</p></li>
<li><p>Similarly, we can adjust vital rates according to suitability values in each patch by specifying functions in the <strong>Relative fecundity</strong> and <strong>Relative survival</strong> options. For this model, we maintained all survival and fecundities equal to 1 (i.e., all the same).</p></li>
<li><p>We do the actual linking to the template metapopulation file in the <strong>Other data from</strong> option. Click on the button with three dots. Navigate to and select the metapopulation file you created in section 3: <a href="#set-template-demographic-parameters-in-ramas-metapopulation">4. Set template demographic parameters in RAMAS Metapopulation</a></p></li>
<li><p>The final parameter that can be edited in this menu is for <strong>Distances</strong>. This will tell RAMAS how to calculate the distances between patches, with the options being edge to edge, center to center, or center to edge. We selected Edge to edge.</p></li>
<li><p>Before closing the menu, one can specify local multipliers and probabilities for catastrophes under the <strong>Catastrophes</strong> tab. We did not have any catastrophes that needed to be adjusted spatially, so we left these blank.</p></li>
<li><p>Click OK to save and close the window.</p></li>
</ul></li>
<li><p>Go to Model &gt; Default population</p>
<ul>
<li>There are three tabs in the Default population menu: General, Density Dependence, and Catastrophes. Again, we left the Catastrophes tab blank, as we were not incorporating these into our model.</li>
<li>The General tab shows several parameters, but most are calculated by RAMAS or specified in the Link to Metapopulation tab. Only the <strong>Local threshold</strong> parameter is available for editing, which can be used to specify patches that are included in the summation of abundance when running the metapopulation model. We set this to 5, assuming that most populations would need more individuals to persist.</li>
<li>The Density Dependence tab will allow us to assign parameters for density dependence. We set the <strong>Density dependence type</strong> to Scramble so that this would be applied to all populations generated with patches. We also incorporated some environmental stochasticity by setting <strong>Standard deviation of K</strong> to 1000, but can be changed to include more or less stochasticity. We left the remaining parameters as default (usually 0).</li>
<li>Click OK to save and exit this menu.</li>
</ul></li>
<li><p>Go to Model &gt; Dispersal</p>
<ul>
<li>The Dispersal menu will allow us to specify a function that controls how far animals disperse between habitat patches, which will calculate dispersal rates for the metapopulation. There are four parameters: <strong><em>a</em></strong>, <strong><em>b</em></strong>, <strong><em>c</em></strong>, and <strong><em>D<sub>max</sub></em></strong>. It is unclear what these all represent, but the manual (p.&nbsp;31) recommends setting <strong><em>a</em></strong> and <strong><em>c</em></strong> to 1 so that the dispersal function simplifies to a negative exponential. We then specified <strong><em>b</em></strong> as 5.0 to represent 5 km, the average natal dispersal for wild pigs, and <strong><em>D<sub>max</sub></em></strong> as 65 km, which we determined from the literature was on the upper limit of wild pig dispersal distances.</li>
<li>The View Function button will only show results after RAMAS has found <span class="math inline">\(\geq\)</span> 2 patches.</li>
<li>Click OK to save and close the menu.</li>
</ul></li>
<li><p>The Model &gt; Correlation menu allows one to specify how different patches/populations are correlated with each other. We left these as default values.</p></li>
</ol>
</section>
<section id="calculate-patches" class="level2">
<h2 class="anchored" data-anchor-id="calculate-patches">6. Calculate Patches</h2>
<ol type="1">
<li>After filling in the menus under Model, we can now tell RAMAS to calculate the patches.</li>
<li>Go to Find patches &gt; Run.
<ul>
<li>This will open a new window showing the progress of the calculations. It will also copy the information from General Information to show what is being run. For our wild pig models, this takes &lt;1 second, but may take longer depending on the neighborhood distance and resolution of the habitat layer.</li>
<li>When the program has finished, it will show ‘End of calculations’ in the message window and ‘Completed’ at the bottom of the window, along with the time it took.</li>
<li>Click OK to close this window.</li>
</ul></li>
<li>After calculating patches, we can explore the Results tab of the main RAMAS Spatial Data program. It would be beneficial to click on the Save button before proceeding further, and selecting Yes when the dialog asks if you would like to save the results.
<ul>
<li><p>Before delineating patches, all of the options under Results will be grayed out, and will become available after calculating patches. Not every option will be relevant for every analysis, so we discuss only the ones examined in this study.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-02-06 102126.png" class="img-fluid figure-img"></p>
<figcaption>Results menu of RAMAS Spatial Data</figcaption>
</figure>
</div></li>
<li><p>The <strong>Habitat suitability map</strong> will open a map of patches labeled by population. The way this map is visualized can be edited by going to View &gt; Options, and changing the option for <strong>Draw patches as</strong>. The ‘solid’ option may be preferred, as it shows only the patches, with each presented in a different color. This visualization can be exported (see section 7).</p></li>
<li><p>Next, we open the <strong>Carrying capacity</strong> results. It will open a graph showing carrying capacity (K) on the y-axis, and population (the patches) on the x-axis. We can also look at this in tabular format by clicking on the Text tab, just above the graph. The text results can be saved as a .txt file for later reference. In addition to patch-level habitat suitability values and carrying capacity, this table also shows the initial abundance for each patch.</p></li>
<li><p>Similarly, we were interested in examining the <strong>Area</strong> of the patches found by RAMAS. It again opens to the graph of Area vs patch, with the option to switch to the Text tab. The Area results provide the size of each patch, as well as the area of core patch (i.e., not edge cells), as well as several landscape configuration metrics, with sums and averages found at the bottom of the table.</p></li>
<li><p>We can preview the populations that were assigned to each patch by opening <strong>Populations</strong>. This is what will be exported to a Metapopulation file in the next step.</p></li>
</ul></li>
</ol>
</section>
<section id="export-results-and-metapop-file-from-spatial-data-module" class="level2">
<h2 class="anchored" data-anchor-id="export-results-and-metapop-file-from-spatial-data-module">7. Export Results and Metapop file from Spatial Data module</h2>
<ol type="1">
<li>It is helpful to export two things after calculating the patches: patch map (helpful for visualizations/manuscript figures) and a Metapopulation file (necessary for continuing the process). Both of these can be accomplished by going to:
<ul>
<li>File &gt; <strong>Save RAMAS Metapop file…</strong> Navigate to the desired folder and provide a file name, then click Save.</li>
<li>File &gt; <strong>Export patch map…</strong> Navigate to the desired folder and provide a file name, then click Save. Note that this will write an ASCII (.asc) file, that can be read into ArcGIS Pro and R and converted to a .tif or other file format.</li>
</ul></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2024-12-16 105241.png" class="img-fluid figure-img"></p>
<figcaption>Exporting patch map and Metapop file from Spatial Data</figcaption>
</figure>
</div>
<section id="converting-.asc-to-.tif-and-plotting-patches-using-arcgis" class="level4">
<h4 class="anchored" data-anchor-id="converting-.asc-to-.tif-and-plotting-patches-using-arcgis">Converting .ASC to .tif and plotting patches using ArcGIS</h4>
<ul>
<li>The ASCII file exported from RAMAS Spatial Data can be read into ArcGIS Pro like any other raster, using Add Data and then navigating to the desired .asc file.</li>
<li>The patch map will not have any Spatial Reference information associated it, so you must add projection data. (Data Management Tools &gt; Define Projection)</li>
<li>Each patch will have a unique pixel value of the patch number.</li>
</ul>
</section>
<section id="converting-.asc-to-.tif-and-plotting-patches-using-r" class="level4">
<h4 class="anchored" data-anchor-id="converting-.asc-to-.tif-and-plotting-patches-using-r">Converting .ASC to .tif and plotting patches using R</h4>
<p>We need to follow essentially the same steps in R, and we can do it efficiently if we have multiple patch rasters exported from RAMAS.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in state boundary shapefile to be able to match projection</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>ms <span class="ot">&lt;-</span> <span class="fu">vect</span>(<span class="st">"data/landscape_data/state_boundary.shp"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># List patch .asc files</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>patches <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path=</span><span class="st">"RAMASoutput/patches/"</span>, <span class="at">pattern=</span><span class="st">".ASC"</span>, <span class="at">full.names=</span><span class="cn">TRUE</span>)  <span class="co"># note that the pattern argument is case-sensitive, and RAMAS writes ASCII files as .ASC instead of .asc like R</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Make raster "stack"</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>patches <span class="ot">&lt;-</span> <span class="fu">rast</span>(patches)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Define projection</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">crs</span>(patches) <span class="ot">&lt;-</span> <span class="fu">crs</span>(ms)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Shorten the names a bit (taking of "_patches")</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(patches) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_patches"</span>, <span class="st">""</span>, <span class="fu">names</span>(patches))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Reclassify so that 0 becomes NA (backround is 0, patches are numbered starting with 1), and all patches receive same class value (1)</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co"># If you want to show different patches, don't do the second part</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace 0 with NA</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>patches <span class="ot">&lt;-</span> <span class="fu">ifel</span>(patches <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA_integer_</span>, patches)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Reclassify all patches as 1</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>patches <span class="ot">&lt;-</span> <span class="fu">ifel</span>(patches<span class="sc">&gt;=</span><span class="dv">1</span>, <span class="dv">1</span>, patches)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over patches and write as .tif</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(patches)[<span class="dv">3</span>]) {</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset to each layer</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  patch <span class="ot">&lt;-</span> patches[[i]]</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create filename</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  filename <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"results/exported_patches/"</span>, <span class="fu">names</span>(patch), <span class="st">".tif"</span>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write raster</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeRaster</span>(patch, filename, <span class="at">overwrite=</span><span class="cn">TRUE</span>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="running-the-actual-metapopulation-model" class="level2">
<h2 class="anchored" data-anchor-id="running-the-actual-metapopulation-model">8. Running the actual Metapopulation model</h2>
<ol type="1">
<li><p>Open the Metapop file that was exported from RAMAS Spatial Data. This can be done by double-clicking the exported .mp file instead of opening RAMAS Metapopulation from the Start menu. Since we set up an initial template population in step 4, we won’t need to edit as much here.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-02-06 113744.png" class="img-fluid figure-img"></p>
<figcaption>Wild pig template metapop (left) and metapop exported from spatial data (right)</figcaption>
</figure>
</div>
<ul>
<li>If the type of density dependence was not specified in the template, go to Model &gt; Density dependence. In the drop down menu for <strong>Density dependence affects</strong>, we parameterized the model so that density only affected fecundities. We also checked the radio button for <strong>Density dependence (and carrying capacity) is based on the abundance</strong> of All stages. Finally, we checked the button for <strong>All populations have the same density dependence</strong> and selected Scramble from the drop-down menu.</li>
<li>Population-specific information can be viewed by going to Model &gt; Populations and clicking the <strong>Display</strong> button in the lower left corner of the General tab. This opens a new menu to show population-specific data, such as how the population is impacted by density dependence, catastrophes, etc. The first option Finite Rate of Increase (lambda) will open a window displaying the population matrix, elasticities, and sensitivies, but doesn’t account for stochasticity, density dependence or sex structure/mating system (full list shown in the window). It also provides an approximate growth rate for the population. Many of the additional options will be more relevant if modeling differences in vital rates between patches.</li>
</ul></li>
<li><p>Go to Simulation &gt; Run. This will project the population out to the specified time frame.</p>
<ul>
<li><p>RAMAS will open a new window as the simulation runs, with the very bottom of the window showing the replication and time step as it calculates. There is a progress bar at the top that will fill green as the simulation runs.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-02-06 114852.png" class="img-fluid figure-img"></p>
<figcaption>Running simulation - default window</figcaption>
</figure>
</div></li>
<li><p>It is also possible to view the simulated population trajectories (i.e., abundance for each replication and time step) as the run by clicking on the graph icon at the top of the simulation window (third from left).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-02-06 114925.png" class="img-fluid figure-img"></p>
<figcaption>Simulated population trajectories</figcaption>
</figure>
</div></li>
<li><p>When incorporating density dependence, there will sometimes be a warning message that the stage matrix is possibly inconsistent. This is not an error, and may occur when density dependence adjust the growth rate so that it is different from what would be due to the population matrix alone. Click the red question mark button for the Help file for more information.</p></li>
<li><p>After the simulation has completed, close the window by clicking the X in the upper right-hand corner. There is no option to save here, the simulation results can be saved from the main Metapopulation program window. If incorporating this simulation in a sensitivity analysis below, the Sensitivity Analysis program will re-run the simulations.</p></li>
</ul></li>
<li><p>Results can be viewed under the Results tab, similar to how we viewed the results from RAMAS Spatial Data.</p>
<ul>
<li>Results &gt; <strong>Trajectory Summary</strong> will show the calculated population trajectory across time steps and summarized over all replications. Again similar to the results in Spatial Data, we can view the results graphically or as text.</li>
<li>There are many Results options that were not relevant to our analysis.</li>
<li>Notably, there doesn’t seem to be a tab that calculates population growth rate (𝜆) while incorporating density dependence and stochasticity, etc. However, we can calculate it in R using the values from Trajectory Summary
<ol type="i">
<li><p>Go to Results &gt; Trajectory Summary, then select the Text tab. Click Save. This will write a .txt file in the specified location.</p></li>
<li><p>The following code can be used to calculate 𝜆 under density dependence or other specified conditions based on a trajectory exported from RAMAS Metapop:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for calculating geometric mean</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>gm_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>){</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exp</span>(<span class="fu">sum</span>(<span class="fu">log</span>(x[x <span class="sc">&gt;</span> <span class="dv">0</span>]), <span class="at">na.rm=</span>na.rm) <span class="sc">/</span> <span class="fu">length</span>(x))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for calculating vector of lambda values</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>lambda_calc <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(y <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(p_core)){</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    lambda[y] <span class="ot">&lt;-</span> x<span class="sc">$</span>Average[y<span class="sc">+</span><span class="dv">1</span>]<span class="sc">/</span>x<span class="sc">$</span>Average[y]</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(lambda)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># read files</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="st">"RAMASoutput/pigs_core_sim.txt"</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>p_core <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(file, <span class="at">skip=</span><span class="dv">14</span>, <span class="at">n_max=</span><span class="dv">11</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Change obnoxious column name</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">allcols=</span><span class="st">`</span><span class="at">Minimum    -1 S.D.    Average    +1 S.D.    Maximum</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># because there are a different number of spaces, just want all whitespace to become a bar</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">allcols =</span> <span class="fu">str_replace_all</span>(allcols, <span class="st">"[[:space:]]+"</span>, <span class="st">"|"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># now separate </span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">separate_wider_delim</span>(allcols, </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>                         <span class="at">names=</span><span class="fu">c</span>(<span class="st">"Time"</span>, <span class="st">"Minimum"</span>, <span class="st">"lSD"</span>, <span class="st">"Average"</span>, <span class="st">"hSD"</span>, <span class="st">"Maximum"</span>),</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">delim=</span><span class="st">"|"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert caracter columns to numeric</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_if</span>(is.character, as.numeric)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate lambda</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>p_core_l <span class="ot">&lt;-</span> <span class="fu">lambda_calc</span>(p_core)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate geometric mean lambda</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="fu">gm_mean</span>(p_core_l)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>Note: it is important to use the <strong>geometric mean</strong> to calculate population growth rate, and <em>not</em> arithmetic mean (R’s <code>mean()</code> function) for an accurate calculation.</p></li>
</ol></li>
</ul></li>
</ol>
</section>
<section id="conducting-a-sensitivity-analysis" class="level2">
<h2 class="anchored" data-anchor-id="conducting-a-sensitivity-analysis">9. Conducting a Sensitivity Analysis</h2>
<ol type="1">
<li><p>The Sensitivity Analysis subprogram allows one to import a metapopulation model and automatically (or manually) adjust values to examine the outcome of different values on the population trajectory. Remember that the simulation values are in <strong>PERCENT</strong> change. Note: the Sensitivity Analysis program will not allow you to save a session.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-01-14 153641.png" class="img-fluid figure-img"></p>
<figcaption>Sensitivity Analysis subprogram</figcaption>
</figure>
</div></li>
<li><p>Go to Models &gt; Automatic. This is the window that will allow you to set up the sensitivity analysis.</p>
<ul>
<li><p>You will need to select a RAMAS Metapopulation file (.mp) to choose as the population that will be modified. Where it says <strong>Model file</strong>, click the button with three dots and navigate to the desired Metapopulation file.</p></li>
<li><p>The <strong>Parameter</strong> drop-down menu allows you to select which parameter will be adjusted with each simulation. We ran a sensitivity analysis of R (maximum growth rates).</p></li>
<li><p>The <strong>No of simulations</strong> option allows you to specify how many scenarios to run. The limit is 5, and the boxes below will open up as more scenarios are added.</p></li>
<li><p>For each scenario (<strong>Sim. X</strong> <span class="math inline">\(\pm\)</span> <strong>% change:</strong>) , enter the percent change you wish to model.</p></li>
<li><p>We examined 10, -10, 20, -20, 30, -30, 40, and -40% variation in <em>R<sub>max</sub></em> which required us to run the simulated trajectories in two different sessions.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-02-06 121519.png" class="img-fluid figure-img"></p>
<figcaption>Sensitivity analysis for wild pigs in MS</figcaption>
</figure>
</div></li>
<li><p>Click OK to save and close the window.</p></li>
</ul></li>
<li><p>Go to Simulation &gt; Run</p>
<ul>
<li><p>RAMAS will give you a dialog box specifying which scenario will be saved to which file. This cannot be edited. Click OK to run the simulations. It will open new simulation windows as the models run.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-02-06 121555.png" class="img-fluid figure-img"></p>
<figcaption>Click Yes to run the simulations</figcaption>
</figure>
</div></li>
<li><p>When the simulations have finished, another new window will open, again stating the new files. Click OK.</p></li>
</ul></li>
<li><p>Results cannot be viewed in the Sensitivity analysis program. Close this.</p></li>
</ol>
</section>
<section id="comparing-simulation-results" class="level2">
<h2 class="anchored" data-anchor-id="comparing-simulation-results">10. Comparing simulation results</h2>
<ol type="1">
<li><p>The RAMAS Comparison of Results subprogram allows you to import models from the Metapopulation subprogram to visualize and compare results of different scenarios. The comparison of results subprogram can take any Metapop model, not necessarily from sensitivity analysis.</p></li>
<li><p>If you open the Comparison of Results subprogram after running a sensitivity analysis, it should automatically load the models generated by Sensitivity Analysis. However, you can add files manually (e.g., if just comparing different models that were created using Metapopulation and not Sensitivity Analysis, such as core, marginal, and highly marginal patch models). Click on the Open symbol to select files. You will need to click Add to navigate and select models to add.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-01-15 150948.png" class="img-fluid figure-img"></p>
<figcaption>Comparison of Results subprogram starts with a blank canvas</figcaption>
</figure>
</div></li>
<li><p>Once the models are loaded, it will show a summary of each in the main window. If comparing results of a sensitivity analysis, each file will be annotated with the sensitivity conditions.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-02-26 102923.png" class="img-fluid figure-img"></p>
<figcaption>Examples of comparing 5 scenarios from a sensitivity analysis</figcaption>
</figure>
</div></li>
<li><p>The results menu is the same as for the Metapopulation model, but it will show all of the selected models instead of a single trajectory. You can click the Text tab to view or save the simulated abundance for each scenario. For each simulation, we copied the results into a .txt file so that they could be read into R.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Screenshot 2025-01-15 145236.png" class="img-fluid figure-img"></p>
<figcaption>Trajectories of core, marginal, and highly marginal patch models</figcaption>
</figure>
</div></li>
</ol>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>